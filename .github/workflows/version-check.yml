name: Version Check

on:
  pull_request:
    branches: [main]

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check versions
        id: check
        run: |
          node scripts/bump-versions.js --check-only --verbose
        continue-on-error: true

      - name: Post fix instructions
        if: steps.check.outcome == 'failure'
        run: |
          echo "## ❌ Version Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some versions need to be updated. Run this command locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "node scripts/bump-versions.js && npm install" >> $GITHUB_STEP_SUMMARY
          echo "git add -A && git commit --amend --no-edit" >> $GITHUB_STEP_SUMMARY
          echo "git push --force-with-lease" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Show version summary
        if: steps.check.outcome == 'success'
        run: |
          echo "## ✓ Version Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| SDK | $(node -p "require('./sdk/js/package.json').version") |" >> $GITHUB_STEP_SUMMARY
          echo "| CLI | $(node -p "require('./cli/package.json').version") (SDK: $(node -p "require('./cli/package.json').dependencies['@fractary/codex']")) |" >> $GITHUB_STEP_SUMMARY
          echo "| MCP | $(node -p "require('./mcp/server/package.json').version") (SDK: $(node -p "require('./mcp/server/package.json').dependencies['@fractary/codex']")) |" >> $GITHUB_STEP_SUMMARY
          echo "| Plugin | $(node -p "require('./plugins/codex/plugin.json').version") |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketplace | $(node -p "require('./.claude-plugin/marketplace.json').metadata.version") |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if versions incorrect
        if: steps.check.outcome == 'failure'
        run: exit 1
